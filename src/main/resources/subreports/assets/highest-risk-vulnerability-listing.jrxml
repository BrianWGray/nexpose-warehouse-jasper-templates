<?xml version="1.0" encoding="UTF-8"?>
<!-- Created with Jaspersoft Studio version 6.3.1.final using JasperReports Library version 6.3.1  -->
<!-- 2016-10-31T15:25:12 -->
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="highest-risk-vulnerability-listing" pageWidth="228" pageHeight="200" columnWidth="228" leftMargin="0" rightMargin="0" topMargin="0" bottomMargin="0" uuid="5969dff1-afee-44d4-96f3-3599083d86b7">
	<property name="com.jaspersoft.studio.data.defaultdataadapter" value="warehouse"/>
	<property name="com.jaspersoft.studio.data.sql.tables" value=""/>
	<property name="com.jaspersoft.studio.unit." value="pixel"/>
	<parameter name="WHERE_FILTER_ASSET" class="java.lang.String">
		<parameterDescription><![CDATA[WHERE clause that can filter assets using asset_id.]]></parameterDescription>
		<defaultValueExpression><![CDATA["true"]]></defaultValueExpression>
	</parameter>
	<parameter name="BASE_DIR" class="java.lang.String" isForPrompting="false">
		<parameterDescription><![CDATA[]]></parameterDescription>
		<defaultValueExpression><![CDATA["../.."]]></defaultValueExpression>
	</parameter>
	<parameter name="LIMIT" class="java.lang.Integer">
		<parameterDescription><![CDATA[The number of services to list.]]></parameterDescription>
		<defaultValueExpression><![CDATA[10]]></defaultValueExpression>
	</parameter>
	<queryString>
		<![CDATA[WITH
   asset_count AS (
      SELECT COUNT(DISTINCT asset_id) AS total_assets
      FROM dim_asset
      WHERE $P!{WHERE_FILTER_ASSET} 
   ),
   vulnerability_assets AS (
      SELECT vulnerability_id, COUNT(DISTINCT asset_id) AS assets
      FROM fact_asset_vulnerability_finding
      WHERE $P!{WHERE_FILTER_ASSET} 
      GROUP BY vulnerability_id
   )
SELECT title, risk_score, assets, exploits, malware_kits, (SELECT total_assets FROM asset_count) AS total_assets
FROM vulnerability_assets
   JOIN dim_vulnerability USING (vulnerability_id)
ORDER BY risk_score DESC, exploits DESC, malware_kits DESC, assets DESC
LIMIT $P!{LIMIT}]]>
	</queryString>
	<field name="title" class="java.lang.String"/>
	<field name="risk_score" class="java.lang.Double"/>
	<field name="assets" class="java.lang.Long"/>
	<field name="exploits" class="java.lang.Long"/>
	<field name="malware_kits" class="java.lang.Long"/>
	<field name="total_assets" class="java.lang.Long"/>
	<columnHeader>
		<band height="18">
			<textField>
				<reportElement mode="Opaque" x="0" y="0" width="125" height="16" forecolor="#4D4D4F" backcolor="#F0F0F0" uuid="f77da95d-a638-4f27-85be-a6097035f5dc">
					<property name="net.sf.jasperreports.export.html.id" value="assetheader"/>
					<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
				</reportElement>
				<box leftPadding="6"/>
				<textElement verticalAlignment="Middle" rotation="None" markup="none">
					<font size="10" isBold="true" isItalic="false" isUnderline="false" isStrikeThrough="false"/>
					<paragraph lineSpacing="Single"/>
				</textElement>
				<textFieldExpression><![CDATA["Vulnerability"]]></textFieldExpression>
			</textField>
			<textField>
				<reportElement mode="Opaque" x="172" y="0" width="56" height="16" forecolor="#4D4D4F" backcolor="#F0F0F0" uuid="e1ca9e8f-8c7b-4d0c-9cb4-22989aaa746b">
					<property name="net.sf.jasperreports.export.html.id" value="assetheader"/>
				</reportElement>
				<box leftPadding="6"/>
				<textElement textAlignment="Left" verticalAlignment="Middle" rotation="None" markup="none">
					<font size="10" isBold="true" isItalic="false" isUnderline="false" isStrikeThrough="false"/>
					<paragraph lineSpacing="Single"/>
				</textElement>
				<textFieldExpression><![CDATA["Assets"]]></textFieldExpression>
			</textField>
			<image>
				<reportElement mode="Opaque" x="216" y="2" width="12" height="12" backcolor="#F0F0F0" uuid="211f3bfe-bab2-4530-a25c-09135d039b2f">
					<property name="com.jaspersoft.studio.unit.width" value="pixel"/>
					<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
				</reportElement>
				<imageExpression><![CDATA[$P{BASE_DIR} + "/images/sort-down.png"]]></imageExpression>
			</image>
			<textField>
				<reportElement mode="Opaque" x="125" y="0" width="47" height="16" forecolor="#4D4D4F" backcolor="#F0F0F0" uuid="6b60851c-9b00-4a1f-ae26-4e633269dfd6">
					<property name="net.sf.jasperreports.export.html.id" value="assetheader"/>
				</reportElement>
				<box leftPadding="0" rightPadding="2"/>
				<textElement textAlignment="Center" verticalAlignment="Middle" rotation="None" markup="none">
					<font size="10" isBold="true" isItalic="false" isUnderline="false" isStrikeThrough="false"/>
					<paragraph lineSpacing="Single"/>
				</textElement>
				<textFieldExpression><![CDATA["Risk"]]></textFieldExpression>
			</textField>
			<image>
				<reportElement mode="Opaque" x="159" y="2" width="12" height="12" backcolor="#F0F0F0" uuid="753a08ef-9d50-4d1a-99f0-ae010d5d81c1">
					<property name="com.jaspersoft.studio.unit.width" value="pixel"/>
					<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
				</reportElement>
				<imageExpression><![CDATA[$P{BASE_DIR} + "/images/sort-down.png"]]></imageExpression>
			</image>
		</band>
	</columnHeader>
	<detail>
		<band height="14">
			<textField isStretchWithOverflow="true" pattern="">
				<reportElement stretchType="RelativeToTallestObject" x="0" y="0" width="125" height="12" uuid="7737c8f5-b876-40fb-9310-25dfb4eec2db">
					<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
				</reportElement>
				<box topPadding="0" leftPadding="3" rightPadding="2"/>
				<textElement>
					<font size="7"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{title}.length() > 80 ? $F{title}.substring(0, 80) + "..." : $F{title}]]></textFieldExpression>
			</textField>
			<textField pattern="#,###">
				<reportElement x="172" y="0" width="56" height="12" uuid="a1ac3497-b42e-400a-b8da-7df9a57301db">
					<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
				</reportElement>
				<box leftPadding="3"/>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="9"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{assets}]]></textFieldExpression>
			</textField>
			<textField pattern="#,###">
				<reportElement x="125" y="0" width="47" height="12" uuid="f250e57f-4ef0-449a-97b1-69ab30f3529b">
					<property name="com.jaspersoft.studio.unit.height" value="pixel"/>
				</reportElement>
				<box leftPadding="3"/>
				<textElement textAlignment="Right" verticalAlignment="Middle">
					<font size="9"/>
				</textElement>
				<textFieldExpression><![CDATA[$F{risk_score}]]></textFieldExpression>
			</textField>
		</band>
	</detail>
</jasperReport>
